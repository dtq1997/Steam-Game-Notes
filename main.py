"""
╔══════════════════════════════════════════════════════════════════════════════╗
║                     STEAM NOTES GENERATOR v5.9.3                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
================================================================================
【AI 协作系统提示词 / System Prompt for AI Maintainers】
如果你（AI）正在处理此文件，请务必遵守以下开发者习惯与规则：

【元规则 - 最高优先级】
0. 【提示词协作】：允许 AI 根据与用户的交流情况，自发在本导言区增加或修改提示词，
   但每次增加或修改提示词前必须先与用户讨论并获得同意。
   AI 必须严格遵照本导言区的所有提示词运作，本导言区规则优先级最高。
   【主动更新】：如果用户提出的需求反映了某些更具一般性的要求，AI 应主动将其整合
   为新的规则添加到本导言区，并在回复中明确告知用户具体修改了哪些内容。
   【及时响应】：当用户明确要求修改导言区内容时，AI 必须立即配合执行修改，
   不得拖延或遗漏。导言区是用户与 AI 之间的"协作契约"，保持其准确和最新
   是最高优先级任务之一。

【项目目标】
本程序用于以编程方式生成/修改 Steam 笔记 (Steam Notes)。
核心用途：由 AI 撰写客观的"游戏说明"笔记，帮助用户的 Steam 好友快速判断
库中的游戏是否适合自己。详见下方【AI 撰写游戏说明笔记的指引】。
也可用于手动创建其他类型的笔记（攻略、日志等），通过本脚本写入 Steam 笔记
文件，使其在 Steam 客户端中可见。

【项目文件架构】
main.py              — 程序入口 + 导言区（提示词和开发规范）
core.py              — 核心业务逻辑（笔记读写、AI 笔记识别工具函数）
account_manager.py   — Steam 账号发现、游戏库扫描、收藏夹读取
ai_generator.py      — AI 笔记生成（多提供商支持、Steam 数据获取）
cloud_uploader.py    — Steam Cloud 直接上传（Steamworks API 封装）
rich_text_editor.py  — BBCode 富文本编辑器组件（独立 Tk 组件）
ui.py                — 主应用框架（SteamNotesApp 核心、游戏列表、Cloud 管理）
ui_notes_viewer.py   — 笔记查看/编辑/创建/删除窗口（NotesViewerMixin）
ui_ai_batch.py       — AI 批量生成窗口（AIBatchMixin）
ui_import_export.py  — 导入/导出/去重对话框（ImportExportMixin）
ui_settings.py       — API 配置、缓存管理、关于（SettingsMixin）
UI 拆分采用 Mixin 模式：各 Mixin 类的方法体与原代码完全一致，self 仍指向
SteamNotesApp 实例。SteamNotesApp 通过多继承组合所有 Mixin。

【Steam 笔记存储机制 - 关键技术细节】
1. 本地路径:
   <Steam安装目录>/userdata/<用户ID>/2371090/remote/
   其中 2371090 是 Steam Notes 功能的固定 AppID

2. 文件命名:
   - 每个游戏对应: notes_<游戏AppID>  (如 notes_570 = Dota 2)
   - 非 Steam 游戏: notes_shortcut_<游戏名>
   - 没有文件扩展名

3. 文件格式: JSON
   {
     "notes": [
       {
         "id": "<8位随机十六进制字符串>",
         "appid": <游戏AppID数字>,
         "ordinal": 0,
         "time_created": <Unix时间戳秒>,
         "time_modified": <Unix时间戳秒>,
         "title": "笔记标题",
         "content": "[p]正文（支持富文本标签如 [h1][b][list] 等）[/p]"
       }
     ]
   }

4. 云同步:
   - 使用 Steam Cloud 同步 (AppID 2371090 的 remote 目录)
   - 本程序通过 Steamworks API (ISteamRemoteStorage::FileWrite) 直接上传
   - 在主界面点击「☁️ 连接 Steam Cloud」后，保存即自动上传到云端
   - 需要 Steam 客户端正在运行，且库中有至少一个已安装游戏（需要 libsteam_api）

【确保云同步的操作流程】
1. 启动 Steam → 2. 打开本程序 → 3. 点击「连接 Steam Cloud」→ 4. 正常编辑，保存即上传

【AI 撰写游戏说明笔记的指引】
本程序的核心用途之一是为用户 Steam 库中的游戏生成"游戏说明"笔记。
这些说明的目标读者是：登上用户账号的随机好友，他们不一定了解独立游戏或单机游戏。
说明的目的是：让读者快速判断这个游戏是否符合自己的兴趣。

⚠️ 撰写游戏说明时必须遵守以下规则（最高优先级）：

1. 【客观描述】：不能照抄游戏商店页面的商业化宣传语。必须客观地告诉读者这个
   游戏是什么、玩起来是什么感觉。
2. 【"现在打开会怎样"】：必须具体描述"如果我现在立刻打开这个游戏，前几分钟
   会看到什么、做什么"——要写到读者脑中能浮现画面，而非"上手难度适中"
   "需要一定学习成本"等模糊概括。这是最重要的信息之一。
3. 【认知资源与时间需求】：必须说明这个游戏需要怎样的注意力投入，让读者知道
   自己需要为它腾出怎样的精力和时间。是否需要大段连续时间、每局/每次游玩大概多久。
4. 【网络口碑】：必须提及这个游戏在网络上是否受欢迎、大致评价如何。
5. 【缺点与不适人群】：必须有一定篇幅介绍缺点，以及明确说明不适合什么样的人玩。
6. 【不用术语、说人话】：禁止使用读者可能不懂的术语而不加解释。例如不能直接说
   "ASCII 风格画面"或"1-bit 风格"，而应该用没玩过游戏的人都能理解的语言描述
   （如"画面几乎完全由彩色文字符号构成——你的角色是一个@，怪物是字母，墙壁
   是#号"）。术语不必刻意回避或删除，解释清楚即可。
7. 【无需强调性价比】：这些游戏默认已在用户库中，属于免费可玩，绝对禁止提及
   任何与价格相关的内容（价格、售价、原价、打折、性价比、定价等）。即使参考资料
   （如 Steam 评测）中大量讨论价格，AI 也必须完全忽略这些信息。
8. 【适合的游玩情景】：必须说明适合自己一个人单独玩还是跟朋友一起玩、适合跟
   什么类型的人玩、适合什么场合（如睡前放松、通勤途中、还是周末空出一整个下午）。
9. 【格式与富文本】：AI 生成的笔记采用"标题=内容"模式——输出纯文本单行，
   禁止换行和 BBCode 标签，同时作为笔记标题和内容显示。这样用户在 Steam 客户端
   的笔记列表中无需点进去就能看到全部说明。所有信息应融入一段连贯自然的叙述中，
   禁止使用分段式小标题（如"初次打开的体验："、"认知资源："等）。
   可适度使用 emoji（📌✅⚠️🗺️⚔️📝🎯）但要克制。建议 200-500 字。
   手动创建的笔记仍可使用 BBCode 富文本标签。
10.【AI 声明前缀】：每条 AI 生成的笔记必须自动在开头添加固定前缀：
   "🤖AI: {信息来源} | 相关信息量：{X}{emoji} | 游戏总体质量：{Y}{emoji}
   ⚠️ 以下内容由 {模型名} 生成，该模型对以下内容的确信程度：{Z}{emoji}。"
   前缀必须以 "🤖AI:" 开头，这是程序识别 AI 笔记的唯一标志。
   信息来源为「📡联网检索」或「📚训练数据与Steam评测」，信息量和确信程度
   均配有颜色 emoji（🟢🔵🟡🟠🔴）。信息量由 AI 严格根据搜索结果/评测中
   有效信息的比例判断（相当多/较多/中等/较少/相当少）。
   游戏总体质量由 AI 综合所有信息后对游戏质量的客观判断（玩法设计、内容量、
   完成度、社区口碑等），使用独立 emoji 体系：💎相当好/✨较好/➖中等/
   👎较差/💀相当差。注意：质量评估 ≠ 确信度（确信度是 AI 对自身描述
   准确性的把握，质量是对游戏本身的评价）。
   【联网回退策略】：联网搜索时，若网络有效信息严重不足，AI 应回退到主要
   依靠 Steam 评测内容撰写说明；只有联网搜索和 Steam 评测都严重不足时才
   输出"信息过少"标注性笔记。
   当信息实在过少时，改为生成标注性笔记：
   "🤖AI: ⛔信息过少 {来源} | 相关信息量：{X}{emoji} 该游戏相关信息过少，
   无法生成有效的游戏说明。（由 {模型名} 判定）"
   此声明由程序自动拼接，无需在系统提示词中要求 AI 输出。

【Steam 笔记富文本标签参考】
Steam 笔记 content 字段支持以下富文本标签（类似 BBCode）：
- [p]段落文本[/p]          — 段落（所有正文文本都应包裹在 [p] 中）
- [h1]标题[/h1]            — 一级标题
- [h2]标题[/h2]            — 二级标题
- [h3]标题[/h3]            — 三级标题
- [b]粗体[/b]              — 粗体文本
- [i]斜体[/i]              — 斜体文本
- [u]下划线[/u]            — 下划线文本
- [strike]删除线[/strike]  — 删除线文本
- [list][*]项目一[*]项目二[/list] — 无序列表
- [olist][*]第一[*]第二[/olist]   — 有序列表
- [hr]                     — 水平分隔线
- [code]代码[/code]        — 代码块
- [url]链接[/url]          — URL 链接
- [url=链接]文本[/url]     — 带显示文本的 URL 链接
⚠️ 注意：AI 生成笔记内容时，正文必须使用 [p]...[/p] 包裹，
  否则在 Steam 客户端中可能显示异常。

【富文本编辑器设计原则】
1. 程序中所有笔记编辑和显示区域都使用富文本（WYSIWYG）模式，而非源码模式。
   用户看到的是渲染后的效果（粗体、斜体、标题等），而非 [b][/b] 等标签源码。
2. 编辑器提供工具栏按钮，对应 Steam 笔记支持的所有富文本功能（粗体、斜体、
   下划线、删除线、标题 H1/H2/H3、段落、无序列表、有序列表、分隔线、代码块）。
3. 底层存储仍使用 Steam 原生 BBCode 标签格式，编辑器负责双向转换：
   - 加载时：BBCode → 富文本渲染显示
   - 保存时：富文本 → BBCode 源码写入文件
4. 编辑器需提供"源码模式"切换按钮，方便高级用户直接编辑 BBCode 源码。
5. 笔记查看器提供"原始文本/富文本"就地切换按钮，用于调试富文本渲染。
6. 【嵌套标签】：BBCode 解析必须支持任意深度的标签嵌套，例如
   [b][i]text[/i][/b]、[list][*][b][url=...]text[/url][/b][/list] 等。
   内联标签解析器（_insert_inline）必须递归调用以正确渲染嵌套结构。
7. 【URL 标签】：必须支持 [url]链接[/url] 和 [url=链接]文本[/url] 两种格式，
   url= 属性值可能带引号（如 [url="..."]），解析时需去除引号。

【导入导出设计原则】
1. 导入操作永远不覆盖已有笔记，导入的内容始终追加在已有笔记之后。
   UI 中不提供"覆盖"选项，以防止误操作。
2. 导出分两种模式：
   - 【单条导出】：在笔记查看页面中选中一条笔记后导出为独立 txt 文件，
     文件名为笔记标题（不可作为文件名的字符自动转义），内容为富文本源码。
   - 【批量导出】：在主界面选择一个、多个或全部游戏，将所有笔记导出为
     一个结构化 txt 文件（含 AppID 和笔记分隔标记）。
3. 导入也分两种对应模式：
   - 【单条导入】：选择一个 txt 文件，作为一条笔记导入到指定 AppID 下。
     文件名自动成为笔记标题。
   - 【批量导入】：选择批量导出格式的 txt 文件，按其中的 AppID 信息
     自动分发到对应游戏下，无需手动指定 AppID。

【开发规范】
1. 【逻辑稳定性】：核心功能（JSON 读写、笔记文件操作）严禁在非必要情况下改动。
2. 【改动确认】：在尝试重构现有功能或大规模调整 UI 前，必须获得用户明确许可。
3. 【UI 习惯】：与 Steam_Library_Manager 保持一致的风格。
4. 【反馈机制】：操作完成后必须显示明确的成功/失败反馈。
5. 【UI 文本风格】：
   - ✅ 表示成功，❌ 表示失败
   - 按钮: emoji + 动宾结构
   - 关键信息: 红色高亮
6. 【账号管理】：启动时自动扫描所有 Steam 账号，支持多账号切换。
7. 【窗口大小】：自适应内容大小，禁止固定 geometry()。
8. 【跨平台】：支持 Windows / macOS / Linux / WSL。
9. 【增量修改】：修改代码时必须以原始文件为基础进行增量编辑（如逐处替换），
   严禁整体重新生成文件。这样既节省 token，也避免引入无关变更或丢失已有功能。
10.【UI 按钮布局】：当按钮或筛选控件较多时应分多行排列，确保所有控件在窗口中
   可见，不被挤出可视区域。同一行内的 Combobox 总数不宜超过 3 个（每个约
   width=8~12），超出时应拆分到下一行。功能切换类按钮（如"原始文本/富文本"）
   应就地切换状态，而非弹出新窗口。新增控件前必须检查目标行的现有控件数量，
   必要时主动拆分行。
11.【调试信息规范】：
   - 所有调试/诊断信息窗口中的文本必须可选中、可复制（不得使用 DISABLED 状态
     阻止文本选择），同时必须提供"📋 复制"按钮一键复制全部内容到剪贴板。
   - 调试信息应包含完整的请求/响应链路：输入参数、请求 URL（隐藏敏感信息）、
     HTTP 状态码、响应体预览、解析结果摘要、错误 Traceback 等。
   - API Key 等敏感信息在调试输出中必须脱敏（仅显示前6位...后4位）。
12.【版本管理】：每次生成新版本文件时，必须递增版本号并在导言区更新日志中
   添加对应条目，版本号格式为 vX.Y 或 vX.Y.Z。
13.【配置持久化】：AI 令牌配置保存为 ai_tokens 列表（每项含 name/key/provider/
   model/api_url），并通过 ai_active_token_index 记录默认令牌。向后兼容旧版
   单 Key 配置（ai_api_key/ai_provider/ai_model/ai_api_url）。
   AI 批量生成窗口提供令牌选择下拉框，用户可自由切换不同令牌。
   Steam Web API Key 和 Steam 配置仍在主界面统一管理。
14.【AI 笔记识别】：AI 生成的笔记以固定前缀 "🤖AI:" 开头。程序通过检测此前缀
   自动识别哪些笔记由 AI 处理过。同时兼容旧版 v2.x 的前缀 "⚠️ 以下内容由"。
   AI 处理过的笔记在列表中显示蓝色，
   未处理的显示默认颜色。可从前缀中提取模型名实现按 AI 模型分类。
15.【笔记创建统一性】：无论是手动创建还是 AI 批量生成，笔记文件的创建都必须
   使用相同的 create_note/write_notes 方法，确保 JSON 格式、时间戳、
   文件结构完全一致。这保证了 Steam Cloud 能正确识别和同步所有笔记。
16.【Steam 分类集成】：AI 批量生成支持按 Steam 收藏夹（分类）筛选游戏，
   通过读取 cloud-storage-namespace-1.json 获取用户收藏夹列表。
17.【延迟上传与 dirty 状态跟踪】：所有笔记改动（新建、编辑、删除、移动、AI
   生成、导入等）仅写入本地文件并标记 dirty。只有用户显式点击上传按钮后才调用
   Steamworks API 上传到 Steam Cloud。主界面游戏列表中，dirty 的条目需要有明显
   标识（颜色 + 图标），并提供每行单独上传按钮和全局批量上传按钮。
18.【列表行内操作按钮】：主界面右侧游戏列表的每个条目右侧提供行内小按钮（如
   📋 复制 AppID），点击后直接执行操作，不弹出额外确认窗口，减少操作步骤。
19.【批量任务生命周期】：AI 批量生成支持暂停/继续/停止。暂停后剩余队列持久化到
   配置文件，关闭窗口后再打开可继续。停止则立即中断并清空队列。关闭窗口时若有
   未上传的笔记，提示用户是否一键上传（自动尝试连接 Steam Cloud）。
20.【启动性能优化】：主界面加载时仅使用持久化缓存快速显示游戏列表，全量游戏名称
   列表（约 15 万条的网络请求）和未知名称解析均在后台线程完成，避免卡顿。
21.【家庭组游戏筛选】：AI 批量生成界面支持录入家庭组成员的 Steam 好友代码
   （保存到配置文件 family_friend_codes），录入后：
   ① 默认视图（无分类选中时）显示家庭组所有成员拥有的游戏（取并集）；
   ② 收藏夹筛选逻辑变为：收藏夹 ∩ 家庭组并集，
   即只显示收藏夹中录入了家庭库的游戏。
22.【缓存管理】：主界面提供「🗑️ 缓存」按钮，打开本地缓存数据管理窗口，
   可查看和清除游戏名称缓存、上传哈希记录、免费游戏缓存等。
   配置文件路径和大小实时显示，AI 令牌和家庭组配置不受清除影响。

【更新日志】
2026-02-11  v5.9.3 — AI 笔记预览窗口修复：
                    - 【关闭按钮修复】修复笔记预览窗口"关闭"按钮无响应的问题：
                      原因是主窗口 grab_set() 拦截了子窗口的事件，现在预览窗口
                      打开时调用 grab_set() 获取焦点，关闭时 grab_release()
                    - 【质量显示修复】修复预览窗口未显示"游戏总体质量"的问题：
                      ① 标题栏新增质量字段（与模型、确信度并列显示）
                      ② 笔记元信息区新增质量字段（与信息来源、信息量并列显示）
2026-02-11  v5.9.2 — 修复第三方代理(中转服务)泄露原始工具调用标记的问题：
                    - 【关键修复】使用第三方代理（中转服务）+ 联网搜索时，代理可能未正确
                      拆分 content blocks，将 <function_calls>、<invoke name="web_search">、
                      <thinking>、<parameter> 等 XML 标签作为纯文本混入 text 块，导致
                      生成的笔记前面出现一大段乱码标记。在 _extract_confidence() 中新增
                      完整的 XML 标记清理逻辑，按优先级依次清除：
                      ① 完整 XML 块及其内容（如 <thinking>...</thinking>、
                        <parameter>...</parameter>）
                      ② 孤立/残余的 XML 标签（如 </invoke> </function_calls>）
                    - 该问题仅在"使用第三方代理 + 启用联网搜索"时出现，官方 API 不受影响
                    - 额外新增"根据搜索结果，..."类中文元叙述前缀的清理
2026-02-11  v5.9.1 — 联网搜索前缀清理 + "游戏总体质量"字段名修正：
                    - 【联网搜索前缀清理】修复联网搜索时 Claude 输出的计划性英文前缀
                      （如 "I'll search for information about this game..."）混入笔记正文
                      的问题。在 _extract_confidence() 中新增正则清理逻辑，自动剥离
                      "I'll/Let me/I need to + search/look up/find..." 等模式的前缀文本
                    - 【字段名修正】前缀中「总体质量」改为「游戏总体质量」，更清晰地
                      表达该字段是对游戏本身质量的评估而非对 AI 生成内容质量的评估
                    - core.py extract_ai_quality_from_note() 正则兼容新旧格式
                      （同时匹配「游戏总体质量：X」和旧版「总体质量：X」）
                    - 导言区提示词同步更新
2026-02-11  v5.9 — AI 质量评估系统 + 多语言搜索策略 + UI 筛选行拆分：
                    - 【质量评估系统】AI 笔记新增"游戏总体质量"维度，独立于确信度，
                      使用专用 emoji 体系：💎相当好/✨较好/➖中等/👎较差/💀相当差。
                      质量是 AI 对游戏本身的客观评价（玩法、内容、完成度、口碑），
                      而确信度是 AI 对自身描述准确性的把握。两者互不干扰。
                    - 【AI 声明前缀更新】笔记前缀新增「游戏总体质量：{Y}{emoji}」字段，
                      格式：🤖AI: {来源} | 信息量：{X}{emoji} | 游戏总体质量：{Y}{emoji}
                      ⚠️ 由 {模型} 生成，确信程度：{Z}{emoji}。
                    - 【质量筛选器】主界面和 AI 批量生成界面新增质量筛选下拉框
                      （全部质量/💎相当好/✨较好/➖中等/👎较差/💀相当差），
                      可与其他筛选器自由组合使用
                    - 【多语言搜索策略】AI 联网搜索提示词强化：
                      ① 必须用英文搜索至少一次（结果通常最丰富）
                      ② 日系游戏额外用日文搜索（RPG/视觉小说/同人游戏）
                      ③ 也用中文搜索一次
                      ④ 根据开发商/发行商国籍判断最佳搜索语言
                    - 【回退策略增强】强调"有效信息比例"概念：即使搜索结果数量多，
                      若大部分不相关，仍应视为"网络有效信息不足"并回退到 Steam 评测
                    - 【UI 溢出修复】主界面筛选器从 2 行拆分为 3 行
                      （行2: 信息来源+确信度, 行3: 信息量+质量），
                      AI 批量生成扫描按钮拆分为 2 行（行1: 在线+本地, 行2: 调试+全选+取消）
                    - 【图例标签】增加 wraplength 防止窄窗口时文字被截断，
                      恢复 ⛔=信息过少 图例项
                    - core.py 新增 QUALITY_EMOJI 常量和 extract_ai_quality_from_note()，
                      scan_ai_notes() 返回结果新增 qualities 字段
                    - ai_generator.py generate_note() 返回值扩展为 6 元组
                      (text, model, confidence, info_volume, is_insufficient, quality)
                    - 向后兼容：旧版笔记无质量标注时显示为空，筛选器默认"全部质量"
2026-02-11  v5.8 — 主界面筛选器重构（并列筛选） + 列表信息来源 emoji + 提示词回退策略：
                    - 【筛选器重构】原单一下拉筛选器拆分为多个并列筛选控件：
                      ① "⬆有改动"改为全局勾选框（Checkbox），不再占用下拉菜单位置
                      ② AI 状态下拉框：全部 / 🤖 AI 处理过 / 📝 未 AI 处理 / ⛔ 信息过少
                      ③ 选择"AI 处理过"时弹出模型二级下拉框（全部 / 各具体模型）
                      ④ 信息来源下拉框：全部 / 📡 联网 / 📚 本地（并列独立筛选）
                      ⑤ 确信程度下拉框：始终可见，可独立筛选（很高/较高/中等/较低/很低）
                      ⑥ 信息量下拉框：始终可见，可独立筛选（相当多/较多/中等/较少/相当少）
                      所有筛选器可自由组合使用（取交集）
                    - 【列表信息来源 emoji】游戏列表中 AI 笔记后缀新增 📡（联网）/ 📚（本地）
                      emoji，直观显示笔记的信息来源类型
                    - 【提示词回退策略】联网搜索时，若网络上有效信息严重不足，AI 必须回退到
                      主要依靠 Steam 评测内容撰写说明；只有联网搜索和 Steam 评测都严重不足时
                      才标注 INSUFFICIENT:true（降低误标率）
2026-02-11  v5.7.2 — UI 代码拆分 + 提示词微调：
                    - 【代码拆分】将 5277 行的 ui.py 按功能拆分为 6 个文件，
                      采用 Mixin 模式（方法体零修改），方便维护：
                      rich_text_editor.py / ui_notes_viewer.py / ui_ai_batch.py /
                      ui_import_export.py / ui_settings.py / ui.py（主框架）
                    - 导言区新增【项目文件架构】一节，说明各文件职责
                    - 【提示词微调】规则第 3 条"认知资源与时间需求"不再强制
                      使用"边看视频边玩"这一特定表达，改为更通用的"注意力投入
                      程度"，让 AI 根据具体游戏类型自行选择合适的描述方式
2026-02-11  v5.7.1 — 家庭库扫描缓存 + 在线扫描按钮文案优化：
                    - 【家庭库缓存】AI 批量生成窗口打开时优先从缓存加载上次的扫描结果，
                      避免每次打开都重新在线扫描数万款游戏；只有点击「在线扫描」时才清除
                      缓存并重新扫描；缓存在 Steam ID 或家庭组成员变更时自动失效
                    - 缓存管理窗口新增「家庭库缓存」条目，可查看和手动清除
                    - 「清除全部缓存」也会同时清除家庭库缓存
                    - 【按钮文案】「在线扫描（完整库）」改为「在线扫描（不含免费游戏）」，
                      更准确地描述 Steam API 的实际行为
2026-02-11  v5.7 — AI 笔记信息量标注 + 信息过少标注性笔记 + 确信度颜色 emoji：
                    - 【确信度颜色 emoji】AI 笔记前缀中的确信程度现在配有与 UI 一致的
                      颜色 emoji（🟢很高 🔵较高 🟡中等 🟠较低 🔴很低），Steam 笔记中更醒目
                    - 【信息来源标注】AI 笔记开头新增信息来源标注：
                      📡联网检索 或 📚训练数据与Steam评测，并标注相关信息量等级
                      （相当多🟢 / 较多🔵 / 中等🟡 / 较少🟠 / 相当少🔴）
                    - 【信息量评估】AI 严格根据搜索结果/评测中的有效信息比例判断信息量，
                      区分"搜索结果多但相关信息少"的情况（如游戏名与其他事物同名）
                    - 【信息过少标注性笔记】当游戏相关信息实在过少（联网搜索和Steam评测
                      均无足够有效信息），生成 ⛔ 标注性笔记而非游戏说明，
                      列表中以红色显示，可通过筛选器筛选
                    - 【新增筛选器】主界面和 AI 生成界面新增三个筛选选项：
                      ⛔ 信息过少 / 📡 联网检索 / 📚 非联网
                    - 【向后兼容】旧版笔记格式（无信息来源和信息量标注）仍能被正确
                      识别、显示和筛选
                    - core.py 新增 INFO_VOLUME_EMOJI、INFO_SOURCE_WEB/LOCAL、
                      INSUFFICIENT_INFO_MARKER 常量和对应的提取函数
                    - ai_generator.py generate_note() 返回值扩展为 5 元组
                      (text, model, confidence, info_volume, is_insufficient)
                    - scan_ai_notes() 返回结果新增 info_volumes、info_sources、
                      has_insufficient 字段
2026-02-10  v5.6 — 家庭组默认视图改为并集 + 游戏名称获取进度条 + 去除免费游戏检测：
                    - 【默认视图改为并集】AI 批量生成界面默认视图（无分类选中时）
                      从显示家庭组交集改为显示家庭组所有成员拥有的游戏的并集，
                      更符合"在家庭库中可以玩到的所有游戏"的实际需求
                    - 【游戏名称获取进度条】主界面启动时如需从 Steam API 获取全量游戏名称，
                      显示进度条和已获取数量（如"已获取 85000 个（第 2 页）"），
                      避免用户误以为程序卡死；获取完成后提示已缓存到本地，下次无需重新获取
                    - 【去除免费游戏检测】收藏夹筛选不再逐个检查未入库游戏是否免费
                      （该功能导致严重卡顿），改为只显示收藏夹与家庭组并集的交集，
                      即收藏夹中录入了家庭库的游戏
                    - 更新开发规范 #21 家庭组游戏筛选：默认视图改为并集，收藏夹不再检测免费游戏
2026-02-10  v5.5 — 缓存管理 + 家庭组默认视图 + 免费游戏支持：
                    - 【缓存管理】主界面新增「🗑️ 缓存」按钮，打开本地缓存数据管理窗口：
                      可查看和清除游戏名称缓存、上传哈希记录、免费游戏缓存，
                      显示配置文件路径和大小，AI 令牌/家庭组配置不受影响
                    - 【家庭组默认视图】录入家庭组成员后，默认视图（无分类选中时）
                      显示所有成员都拥有的游戏（交集），而非单个用户的游戏库，
                      统计信息显示「家庭组共 X 款，所有人都有 Y 款」
                    - 【免费游戏支持】收藏夹 + 家庭组筛选时，自动通过 Steam Store API
                      检测分类中未入库游戏是否为免费游戏，免费游戏自动包含在显示列表中，
                      检测结果持久化到配置文件（free_apps_cache），避免重复请求
                    - SteamAccountScanner 新增 check_free_apps() 方法（批量检测免费游戏）
                    - _scan_family_members 同时计算家庭组并集和交集
                    - 更新开发规范 #21 家庭组游戏筛选（新增默认交集视图和免费游戏逻辑）
                    - 新增开发规范 #22 缓存管理
2026-02-10  v5.4 — 启动性能优化 + 家庭组游戏筛选：
                    - 【启动性能优化】主界面初始加载时仅使用持久化的游戏名称缓存快速显示，
                      全量名称列表获取（网络请求约 15 万条）和未知名称解析均移至后台线程，
                      彻底消除选择账号后的长时间卡顿（尤其是有数千条笔记时）
                    - 新增 _ensure_game_name_cache_fast() 方法（仅读持久化缓存 + 本地扫描）
                    - 新增 _bg_init_game_names() 后台线程统一管理名称缓存初始化
                    - 【家庭组游戏筛选】AI 批量生成界面新增「👨‍👩‍👧‍👦 家庭组」管理功能，
                      可录入多个家庭组成员的 Steam 好友代码（持久化到配置文件），
                      在线扫描时自动扫描所有家庭组成员的游戏库，收藏夹筛选逻辑变为：
                      收藏夹 ∩ 家庭组所有成员拥有的游戏（取并集），
                      解决收藏夹中含有特殊手段写入的不可玩游戏被错误包含的问题
                    - 新增开发规范 #20 启动性能优化 和 #21 家庭组游戏筛选
2026-02-09  v5.3.2 — 手动标记已同步功能：
                    - 【标记已同步】右键菜单新增「✅ 标记为已同步」选项，
                      可手动消除因历史残留导致的虚假 dirty 标记（如从云端下载
                      的笔记被误判为有改动），支持单选和多选操作
2026-02-09  v5.3.1 — 右侧面板紧凑化 + 上传按钮宽度修复 + 关于作者按钮：
                    - 【右侧面板紧凑化】右侧控制面板内边距、按钮宽度、间距全面缩减，
                      Cloud 状态文本和路径标签限制宽度，大幅减少无意义空白
                    - 【上传按钮宽度修复】工具栏「☁️全部」按钮宽度从 6 增至 9，
                      修复显示 dirty 数目时文本被截断的问题
                    - 【关于作者按钮】右侧面板底部新增「ℹ️ 关于」按钮，
                      点击弹出作者信息窗口（含联系方式和 Steam 主页链接），
                      不占用主界面空间
2026-02-09  v5.3 — 主界面 UI 大幅重排 + 导入冲突双模式 + 笔记去重：
                    - 【主界面重排】笔记列表移至左侧（仿 Steam 界面布局），
                      控制按钮区移至右侧，消除大片空白，布局更紧凑合理
                    - 【导入冲突双模式】批量导入时新增两种冲突检测模式：
                      ① AI 冲突检测（原有）：检测导入文件中 AI 笔记与已有 AI 笔记的冲突
                      ② 字面重复检测（新增）：检测导入笔记标题/内容是否与已有笔记完全重复
                      导入窗口新增模式选择，用户可按需切换
                    - 【笔记去重】主界面新增「🔍 去重」按钮，扫描所有笔记中的重复项
                      （按标题+内容完全匹配），列出重复笔记供用户选择删除
2026-02-09  v5.2.1 — Cloud 断开清理状态 + 账号不匹配拒绝连接：
                    - 【断开清理】断开 Steam Cloud 时，shutdown 后立即清空
                      remote_storage 和 logged_in_friend_code，避免残留状态
                    - 【账号不匹配拒绝连接】连接 Steam Cloud 时若检测到登录账号与程序
                      选择的账号不一致，立即 shutdown 并拒绝连接（而非连接后仅警告），
                      主界面和 AI 批量生成窗口均适用
2026-02-09  v5.2 — 导入确认窗口优化 + 游戏名称扫描重做 + 导出 AI 筛选 + Cloud 账号检测
                    + 导入 AI 冲突处理 + 持久化 dirty 检测：
                    - 【导入确认窗口】批量导入大量笔记时，结果摘要从 messagebox 改为
                      可滚动的 Toplevel 窗口，确认按钮始终可见，不再因内容过多而溢出屏幕
                    - 【游戏名称扫描重做】新增 fetch_all_steam_app_names() 方法，通过
                      ISteamApps/GetAppList/v2/ 一次性获取 Steam 全量应用名称列表
                      （无需 API Key，约 15 万条），缓存到本地配置文件，作为游戏名称
                      解析的主要数据源；不再依赖按账号扫描的 GetOwnedGames，
                      任何 AppID 都能正确显示游戏名
                    - 【导出 AI 筛选】修复筛选 AI 笔记后导出仍会导出所有笔记的问题；
                      导出对话框新增「🤖 仅导出 AI 笔记」复选框，当主界面筛选为
                      AI 相关时自动勾选；export_batch 和 export_individual_files 方法
                      新增 note_filter 参数支持按条件过滤导出
                    - 【Cloud 账号不匹配检测】修复为小号生成的笔记上传后出现在大号的严重
                      Bug：连接 Steam Cloud 时通过 Steamworks API (SteamUser::GetSteamID)
                      检测当前登录的 Steam 账号，若与程序选择的账号不一致则弹出醒目警告；
                      主界面和 AI 批量生成窗口的 Cloud 状态栏均显示红色「账号不匹配」提示；
                      关闭 AI 窗口自动上传前也会检查并确认
                    - 【导入 AI 笔记冲突处理】批量导入时若导入文件中的 AI 笔记与目标
                      AppID 已有 AI 笔记冲突，弹出冲突处理窗口：可选「全部替换/全部追加/
                      跳过 AI/逐一处理」；逐一处理模式下左右两栏对比已有和导入的 AI 笔记，
                      逐个游戏选择替换/追加/跳过；import_batch 重构为 parse → detect →
                      apply 三步流程，新增 parse_batch_file 和 apply_batch_import 方法
                    - 【持久化 dirty 检测】上传笔记到 Cloud 后记录文件 MD5 哈希到配置文件，
                      重启程序时通过对比本地文件哈希与上次上传的哈希，自动检测哪些笔记
                      需要重新上传；彻底解决「关闭程序后丢失 dirty 状态」的问题
2026-02-09  v5.1 — 主界面大幅优化 + 游戏名称显示 + 搜索功能：
                    - 【游戏名称显示】笔记列表显示游戏名而非 AppID，名称缓存持久化到
                      配置文件，启动时后台线程自动通过 Steam Store API 解析未知名称
                    - 【双模式搜索】右侧列表新增搜索栏，支持两种模式切换：
                      ① 按游戏名/AppID 搜索 ② 按笔记内容搜索
                    - 【主界面精简】移除冗余帮助文本、AppID 速查表、路径信息框，
                      按钮布局紧凑化，Cloud 状态合并为单行，整体高度大幅缩减
2026-02-09  v5.0.1 — 系统提示词优化（"现在打开会怎样"具体化）：
                    - 规则第2条大幅强化：要求 AI 描述"打开后会看到什么界面、做什么
                      操作、遇到什么状况"，而非"上手难度适中"等模糊概括；
                      增加正面示例和❌负面禁止示例，配合自查清单同步更新
2026-02-09  v5.0 — AI 批量生成：暂停/继续/停止 + 关闭时上传提示：
                    - 【暂停/继续】生成过程中可随时暂停，剩余队列自动保存到配置文件，
                      关闭窗口后重新打开可从断点继续；暂停期间按钮变为「▶️ 继续」
                    - 【停止】立即中断当前生成任务并清空队列
                    - 【关闭时上传提示】关闭 AI 批量生成窗口时若检测到未上传的笔记，
                      弹窗询问是否一键上传到 Steam Cloud；选「是」时自动尝试连接
                      Steam Cloud（若尚未连接），连接失败则返回窗口
                    - 新增开发规范第 19 条【批量任务生命周期】
2026-02-09  v4.9 — AI 批量生成窗口 UI 布局紧凑化：
                    - 【布局优化】AI 批量生成窗口整体布局大幅紧凑化，减少冗余间距和
                      重复标题，令牌信息与 Cloud 状态合并为单行显示，Steam API 状态
                      与 Steam ID 输入合并为单行，分类筛选与刷新按钮同行，
                      扫描/全选/调试按钮合并为单行，AI 筛选移至游戏数量信息同行，
                      减小窗口最小尺寸，确保在较小屏幕上也能完整显示所有控件
2026-02-09  v4.8 — 多令牌管理 + 斜体修复 + AI 页面 Cloud 连接：
                    - 【多令牌管理】API Key 配置页面全面重构，支持保存和管理多个
                      AI 令牌（每个令牌含名称、提供商、模型、API URL、Key），
                      在 AI 批量生成页面可通过下拉框自由切换令牌，适应不同开销需求
                    - 【AI 页面 Cloud 连接】将 Steam Cloud 连接/断开按钮添加到
                      AI 批量生成页面，生成完成后可直接连接并上传，无需返回主界面
                    - 【斜体渲染修复】富文本编辑器使用显式字体族名解析，修复部分
                      平台下斜体样式无视觉效果的问题（italic font 未正确渲染）
                    - 配置结构新增 ai_tokens 列表和 ai_active_token_index，
                      保持与旧单 Key 配置的向后兼容
2026-02-09  v4.7 — AI 提示词强化 + 批量生成界面增强：
                    - 【提示词强化 - 禁止提及价格】规则第7条大幅强化措辞，增加
                      负面示例和明确禁止词列表（原价/打折/性价比/售价等），
                      并在 user_msg 末尾 reminder 中重复强调，防止 Steam 评论中的
                      大量性价比讨论"污染" AI 输出
                    - 【批量生成 - 有改动筛选】AI 筛选器新增「☁️ 有改动」选项，
                      与主界面筛选器完全一致，方便快速查看刚生成/修改过的笔记
                    - 【批量生成 - 云同步按钮】底部按钮栏新增「☁️上传选中」和
                      「☁️全部上传」两个云同步按钮，生成满意后可直接上传到
                      Steam Cloud，无需返回主界面操作
2026-02-09  v4.6 — 导出功能增强 + 全选：
                    - 【全选按钮】主界面工具栏新增「✅全选」按钮，一键选中当前筛选项
                      下的所有游戏（再次点击取消全选），方便批量操作上千条笔记
                    - 【双模式导出】导出按钮改为弹窗选择两种模式：
                      ① 逐条导出：每条笔记保存为独立 .txt 文件（文件名=标题，内容=BBCode）
                      ② 合并导出：所有笔记写入单个结构化 .txt 文件，可在其他账号上导入还原
                    - 新增 SteamNotesManager.export_individual_files() 方法，支持同名去重
                    - 右键菜单新增单个游戏导出入口，多选时也使用新导出对话框
2026-02-09  v4.5.1 — AI 格式遵守修复 + UI 细节优化：
                    - 【提示词强化】评测等参考资料用明确边界标记包裹，
                      并在 user_msg 末尾重复关键格式要求（reminder 技巧），
                      防止大量参考资料"淹没"系统提示词导致 AI 不遵守格式
                    - 【配置文件夹快捷入口】AI 配置页面的路径文字变为可点击链接，
                      点击直接打开 ~/.steam_notes_gen/ 目录
                    - 【确信度筛选修复】筛选下拉框始终显示全部 5 个等级
                      （很高/较高/中等/较低/很低），不再只显示当前数据中存在的等级
                    - 【批量生成 - 图例精简】移除 AI 筛选行的拥挤图例说明
                    - 【笔记预览修复】双击预览窗口现在只显示 AI 笔记（无 AI 笔记时
                      回退显示手动笔记）；修复 scrollbar 父级错误导致关闭按钮冻结；
                      窗口大小自适应内容长度
2026-02-09  v4.5 — AI 信息源大幅增强（评测接入 + 联网搜索 + 代理兼容修复）：
                    - 【Steam 评测接入】新增 get_game_reviews_from_steam() 方法，
                      通过 Steam appreviews API 获取「最有帮助」的玩家评测文本，
                      使用 purchase_type=steam 过滤，并排除 received_for_free 的评测
                    - 【好评率】从评测 API 的 query_summary 中提取好评率、评价等级
                      （如"特别好评"、"褒贬不一"）和评价总数，写入 AI 参考上下文
                    - 新增 format_review_context() 方法，将评测摘要格式化为 AI 可参考文本，
                      包含好评/差评各取最有帮助的若干条（截取前300字），中英文各取一批
                    - 【Claude 联网搜索】Anthropic 提供商新增可选的 Web Search 功能，
                      在底部按钮栏勾选「🔍 联网搜索」后，Claude 可自行上网搜索游戏信息
                      （需 Anthropic 官方 API + 额外费用 $10/1000次搜索）
                    - 使用第三方代理（自定义URL）时自动禁用联网搜索并给出说明
                    - _call_anthropic() 支持 web_search_20250305 工具和对应 beta header
                    - generate_note() 新增 use_web_search 参数
                    - 【代理兼容性修复】使用第三方代理（new-api/one-api 等）时，
                      自动添加 Authorization: Bearer 认证头，兼容需要 Bearer Token
                      格式的代理服务（修复"未提供令牌"401错误）
                    - 响应解析同时兼容 Anthropic 格式和 OpenAI 格式（choices[0].message）
                    - 【确信度 emoji】全局引入 CONFIDENCE_EMOJI 映射（🟢很高 🔵较高 🟡中等 🟠较低 🔴很低），
                      在主界面和 AI 批量生成界面的游戏列表中，AI 处理过的游戏名后显示确信度 emoji
                    - 【批量生成 - 确信度筛选】AI 筛选选中"AI处理过"或具体模型时，
                      自动显示确信度二级筛选下拉框（与主界面一致）
                    - 【批量生成 - 双击预览笔记】双击游戏列表中的条目，弹出笔记预览窗口，
                      清晰展示 AI 笔记正文、确信度、模型信息；手动笔记也一并显示
                    - 【UI 优化】全局选项（跳过已有AI笔记、联网搜索）移至底部按钮栏，
                      在"从Steam库选择"和"手动输入AppID"两种模式下均可见
                    - 简化笔记覆盖逻辑：取消勾选"跳过已有AI笔记"时，自动替换旧AI笔记
                    - 401 错误时给出具体排查建议并停止后续生成（避免浪费时间）
2026-02-09  v4.4 — 确信度筛选 + 列表多选导出 + 游戏名修复：
                    - 修复游戏名称不显示的 bug：刷新时强制重建缓存，
                      在线扫描失败时输出简短提示而非静默吞没
                    - 新增 extract_ai_confidence_from_note() 函数，从 AI 笔记标题解析确信度
                    - scan_ai_notes 返回结果新增 confidences 字段
                    - 筛选「AI 处理过」或具体模型时，自动出现确信度二级筛选下拉框
                    - 列表改为多选模式（selectmode=extended），支持 Ctrl/Shift 多选
                    - 列表上方工具栏新增「📤 批量导出」按钮，直接导出选中的游戏笔记
                    - 移除旧版「📤 批量导出」按钮及其弹窗（功能已整合到列表工具栏）
2026-02-09  v4.3 — 主界面 UI 优化 + 游戏名称解析：
                    - 游戏名称：优先使用 Steam Web API 在线解析游戏名（需配置 API Key），
                      结果缓存至 _game_name_cache 避免重复请求；本地扫描作为 fallback
                    - 列表上方新增紧凑工具栏（📋复制ID / ☁️上传选中 / ☁️全部上传），
                      列表下方仅保留 🔄刷新 和 📋查看，整体更窄更紧凑
                    - Treeview 列宽收窄（#0: 340→280），减少右侧面板整体宽度
                    - 新增 UI 提示文本：「☁️ 上传后仍需等待 Steam 自动同步到云端」
2026-02-09  v4.2 — Steam 进程监控 + 列表性能优化：
                    - 新增 Steam 进程后台监控：连接 Cloud 后每 5 秒检测 Steam 是否在运行，
                      一旦检测到 Steam 关闭，自动断开 Cloud 连接并更新界面状态
                    - SteamCloudUploader 新增 is_steam_running() 静态方法（跨平台）
                    - 右侧游戏列表从 Canvas+Frame-per-row 改为 ttk.Treeview 实现，
                      大幅减少 widget 数量，数百条目也能流畅滚动
                    - 行内按钮（📋 ☁️）改为底部按钮 + 右键菜单，保留全部功能
2026-02-09  v4.1 — 延迟上传 + 行内操作按钮：
                    - 所有笔记改动仅写入本地，标记 dirty，不自动上传
                    - 主界面游戏列表改为 Canvas 滚动列表，每行带行内按钮
                    - 每行右侧 📋 按钮一键复制 AppID（无弹窗）
                    - dirty 条目显示 ☁️ 上传按钮和黄色高亮
                    - 底部新增「☁️ 全部上传」批量上传按钮
                    - 筛选器新增「☁️ 有改动」选项
                    - 导言区新增规则 #17 延迟上传 和 #18 行内操作按钮
2026-02-09  v4.0 — Steam Cloud 直接上传（重大改进）：
                    - 通过 Steamworks API (ISteamRemoteStorage::FileWrite) 直接上传笔记到 Steam Cloud
                    - 主界面新增「☁️ 连接 Steam Cloud」按钮，连接后保存即自动上传
                    - 自动搜索已安装 Steam 游戏中的 libsteam_api 动态库
                    - 移除旧版「删除该笔记以触发云同步」机制（不再需要手动操作）
                    - 移除"⚠️ 需要云同步"筛选器和红色标记（不再需要）
                    - 保存笔记后不再关闭重开窗口，交互更流畅
                    - 删除全部笔记时同步从 Steam Cloud 删除
                    - 新增 SteamCloudUploader 类，封装 Steamworks API 调用
2026-02-08  v3.5 — AI 批量生成功能优化（家庭共享支持）：
                    - 打开 AI 批量生成窗口时自动触发在线扫描（如已配置 Steam API Key 和 Steam ID）
                    - 【核心改进】收藏夹筛选改为交集逻辑：选择收藏夹后，只显示"该收藏夹中且被扫描用户拥有的游戏"
                    - 这样在扫描家庭组成员时，选择自己的收藏夹，就只会显示该成员拥有的游戏
                    - 避免在家庭组成员没有的游戏上浪费 AI token
                    - 统计信息更清晰：显示"收藏夹共 X 款，该用户拥有 Y 款"
2026-02-08  v3.4 — 多项界面改进：
                    - 修复保存提示词时的参数错误
                    - AI批量生成窗口打开时自动扫描本地游戏库
                    - 主界面笔记列表显示游戏名称而不仅仅是AppID
                    - 需要云同步的游戏支持点击复制AppID（右键菜单）
2026-02-08  v3.2 — 新增筛选功能：
                    - 主界面筛选器新增"⚠️ 需要云同步"选项
                    - 可快速筛选出所有需要在 Steam 内手动触发云同步的游戏
                    - 新增UI提示标签说明红色代表需要云同步
2026-02-08  v3.1 — 云同步触发机制增强：
                    - 修改、删除、上移、下移笔记后立刻刷新显示同步触发笔记
                    - 保存修改后立刻关闭并重开窗口以显示同步触发笔记
                    - 禁止在程序内删除云同步触发笔记（第一条提醒笔记受保护）
                    - 禁止移动云同步触发笔记或将其他笔记移动到第一位（保护第一位置）
                    - delete_note、move_note 方法现在会自动调用 _insert_sync_trigger_note
                    - move_note 方法新增保护逻辑，防止破坏同步触发笔记的第一位置
2026-02-08  v3.0 — 云同步触发机制：每次创建/修改笔记后自动在 appid 列表开头
                    插入特殊笔记"删除该笔记以触发云同步"，并在游戏列表中标红
                    显示需要在 Steam 内手动处理的游戏，解决云同步延迟问题
2026-02-06  v2.0 — 带 GUI 的完整版本，参考 Steam_Library_Manager 架构
                    自动扫描 Steam 路径和账号
                    支持创建/查看/编辑/删除笔记
2026-02-06  v2.1 — 富文本编辑器（WYSIWYG）: 所有编辑和显示区域均渲染富文本，
                    工具栏支持全部 Steam 笔记标签，可切换源码模式
                    重新设计导入导出: 单条导出/批量导出 + 对应两种导入模式
                    导入操作始终追加，不再提供覆盖选项
2026-02-06  v2.2 — 修复富文本编辑器 bug:
                    - 修复加粗/斜体/下划线等内联样式被段落 tag 覆盖的问题
                      (使用 tag_raise 确保内联样式优先级高于块级样式)
                    - 无选区点击内联格式按钮时，进入"预设模式"——
                      后续输入的文字自动带该格式，而非静默无反应
                    新增 URL 自动识别: 编辑器和显示区域自动检测 URL 并高亮为
                    可点击链接（蓝色下划线，鼠标变手型）
                    新增 🤖 AI 批量生成: 调用 Anthropic API (Claude) 为 Steam
                    库中的游戏批量生成"游戏说明"笔记，遵循导言区撰写指引
2026-02-07  v2.2.1 — 修复 [url] / [url=...] BBCode 标签未被解析的 bug:
                      之前 [url][/url] 标签会作为纯文本显示，现在正确解析并渲染
                      为可点击链接，支持 [url]链接[/url] 和 [url=链接]文本[/url]
                      修复 [url="..."] 带引号属性未正确解析的问题
                      修复嵌套内联标签不渲染的问题（如 [b][i]text[/i][/b]）:
                      _insert_inline 改为递归实现，支持任意深度嵌套
                      修复列表项中的内联标签（[b][url]等）不渲染的问题
                      标题和顶级内联 token 也支持嵌套内联标签
                      列表项解析时自动去除 [p]...[/p] 包裹
                      "📄 原始文本"改为就地切换（非弹窗），点击切换原始/富文本
                      按钮区改为双行布局，确保上移/下移按钮始终可见
                      斜体样式增加颜色区分以提升可辨识度
                      导言区新增开发规范 #9 增量修改 和 #10 按钮布局规则
                      导言区富文本编辑器设计原则新增嵌套标签和 URL 标签规则
2026-02-07  v2.2.2 — 修复列表项 [/*] 闭合标签未被正确处理的 bug:
                      列表项中 [p][b]...[/b][/p][/*] 格式现在正确解析，
                      先去除 [/*] 再去除 [p]...[/p] 包裹，内联标签正常渲染
                      修复 [*] 和 [/*] 标签在顶层解析器中导致的文本丢失问题
                      调整标题字号以匹配 Steam 客户端实际显示效果:
                      H1: 18→22, H2: 15→17, H3: 13→14
2026-02-07  v2.3   — AI 批量生成功能增强:
                      新增系统提示词显示/编辑区域（可展开/收起/恢复默认）
                      采用"标题=内容"模式: AI 输出纯文本单行，同时作为笔记标题和内容，
                      在 Steam 笔记列表中无需点进去即可看到全部说明
                      移除"笔记标题"输入框（不再需要固定标题）
                      自动去除 AI 输出中的换行和残留 BBCode 标签
                      generate_note 方法新增 system_prompt 参数支持自定义提示词
                      更新系统提示词: 禁止分段式小标题，要求连贯叙述风格
                      更新导言区 AI 撰写指引第 8 条以反映新格式要求
2026-02-07  v2.4   — AI 批量生成功能增强 — 游戏库扫描:
                      新增 SteamAccountScanner.scan_library() 方法，
                      扫描 steamapps/appmanifest_*.acf 获取用户库中所有已安装游戏
                      支持多库目录（通过 libraryfolders.vdf 发现额外 Steam 库文件夹）
                      AI 批量生成窗口新增双模式切换:
                        模式1「📚 从 Steam 库选择游戏」— 扫描库后以列表展示，
                        支持全选/取消全选/多选/搜索筛选
                        模式2「✏️ 手动输入 AppID」— 保留原有手动输入方式
                      列表显示实时已选数量，搜索框支持按游戏名或 AppID 即时筛选
2026-02-07  v2.5   — 游戏库扫描大幅增强:
                      新增 scan_library_online() 方法，通过 Steam Web API
                      (IPlayerService/GetOwnedGames) 获取用户完整游戏库，
                      包含未安装的游戏和免费游戏，结果远比本地扫描完整
                      支持输入任意 Steam ID / 好友代码扫描他人的库（如家庭共享来源）
                      好友代码（32位）自动转换为 Steam 64位 ID
                      在线扫描为主要方式，本地扫描保留为 fallback
                      AI 声明前缀: 每条生成的笔记自动添加
                      "⚠️ 以下内容由 {模型名} 生成，该模型对以下内容的确信程度：{X}"
                      确信程度由 AI 根据自身对该游戏的了解程度自评
                      (很高/较高/中等/较低/很低)，从 API 响应中解析实际模型名
                      导言区新增【AI 声明前缀】规则
2026-02-07  v2.6   — 调试信息可复制:
                      调试信息窗口中的文本现在可以直接选中复制，
                      不再需要截图（修复 Text widget DISABLED 阻止选择的问题）
                      API Key 持久化:
                      主界面新增「🔑 API Key 设置」，可保存 Anthropic API Key 和
                      Steam Web API Key 到本地配置文件（~/.steam_notes_gen/config.json），
                      保存后全局使用，无需每次输入；支持查看、清除已保存的 Key
                      AI 生成前自动获取游戏详情:
                      在调用 AI 之前，自动通过 Steam Store API (appdetails) 获取游戏的
                      完整信息（开发商、发行商、类型标签、功能特性、官方简介、Metacritic
                      评分、评价数、发行日期等），作为补充上下文传给 AI，大幅提升
                      冷门/独立游戏说明的准确性
                      新增 get_game_details_from_steam() 和 format_game_context() 方法
                      导言区新增开发规范 #11 调试信息规范 和 #12 版本管理规则
2026-02-07  v2.7   — 多 AI 提供商支持:
                      重构 SteamAIGenerator 类，支持 Anthropic (Claude)、OpenAI (GPT)、
                      DeepSeek 及任意 OpenAI 兼容 API（自定义 URL）
                      输入 API Key 后自动根据前缀检测提供商（sk-ant- → Anthropic,
                      sk- → OpenAI），并自动切换可用模型列表
                      新增"自定义 (OpenAI 兼容)"模式，支持填写任意 API URL
                      AI 批量生成窗口 UI 大幅重排:
                      采用 PanedWindow 左右+上下分割布局，左列 API 设置+提示词，
                      右列游戏列表，下方进度区。设置最小窗口尺寸 900×700，
                      游戏列表和按钮不再被挤压截断。搜索框与状态信息同行显示，
                      操作按钮分两行排列确保全部可见
2026-02-08  v2.8   — 所有提供商支持自定义 API URL:
                      任何提供商（Anthropic / OpenAI / DeepSeek）均可覆盖默认 API URL，
                      支持第三方中转服务（如 CC-max 等）使用 Anthropic 格式端点
                      自定义 URL 输入框在所有提供商下均可见（带默认值占位提示），
                      留空时使用官方默认地址，填写后覆盖
                      自动检测提供商逻辑优化: 非 sk-ant- 开头的 Key 不再自动切换提供商，
                      避免中转服务 Key 被误判
2026-02-08  v3.0   — 重大功能更新:
                      【持久化配置】主界面 API Key 设置升级为完整的 AI 配置管理:
                      提供商、模型、自定义 URL 均可保存到本地配置文件，
                      AI 批量生成窗口不再重复显示 API 配置，仅显示提示词和游戏列表
                      【AI 前缀识别】AI 生成的笔记强制以固定前缀 "🤖AI:" 开头，
                      程序自动扫描识别 AI 处理过的笔记，后续批量生成默认跳过，
                      可选择重新生成覆盖；AI 处理过的笔记在列表中显示蓝色，
                      鼠标悬停可查看是哪个 AI 模型处理的
                      【Steam 分类筛选】AI 批量生成支持按 Steam 收藏夹/分类筛选游戏，
                      通过读取 cloud-storage-namespace-1.json 获取用户收藏夹列表，
                      选择分类后只处理该分类内的游戏
                      【AI 筛选器】主界面和 AI 生成界面新增 AI 处理状态筛选器：
                      可一键过滤已处理/未处理的游戏，按不同 AI 模型分类查看，
                      双击即可打开查看笔记
                      【配置布局优化】AI 生成界面更紧凑：API 状态显示为只读摘要，
                      Steam API Key 和 ID 也仅显示配置状态提示
                      【笔记创建统一性】AI 生成笔记使用与手动创建完全相同的
                      create_note 方法，确保文件格式和云同步行为一致
2026-02-08  v3.0.1 — 修复 AI 笔记识别不兼容旧格式:
                      新增 AI_NOTE_PREFIX_LEGACY 支持，同时识别旧版 "⚠️ 以下内容由"
                      和新版 "🤖AI:" 两种前缀，确保已有 AI 笔记能被正确检测
                      修复 Steam 分类筛选与游戏库取交集的问题:
                      选择分类后显示该分类内的所有 AppID（不再要求游戏在库中），
                      分类中的游戏如果在库中则显示游戏名，否则显示 "AppID xxx"
                      恢复 Steam ID 输入框:
                      AI 批量生成窗口恢复 Steam ID 输入框，允许填写家庭组其他成员 ID
                      以扫描其游戏库（适用于家庭共享场景）
================================================================================
"""

from ui import SteamNotesApp

if __name__ == "__main__":
    app = SteamNotesApp()
    app.run()
